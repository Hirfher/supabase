const STRIPE_SECRET = Deno.env.get('STRIPE_TEST_SECRET') || '';
const ALLOWED_ORIGINS = (Deno.env.get('ALLOWED_ORIGINS') || '*').split(',').map((s)=>s.trim());
async function stripeRequest(path, method = 'POST', body) {
  const url = `https://api.stripe.com${path}`;
  const headers = {
    Authorization: `Bearer ${STRIPE_SECRET}`,
    'Content-Type': 'application/x-www-form-urlencoded'
  };
  const res = await fetch(url, {
    method,
    headers,
    body
  });
  const text = await res.text();
  try {
    return {
      status: res.status,
      data: JSON.parse(text)
    };
  } catch  {
    return {
      status: res.status,
      data: text
    };
  }
}
function corsHeaders(origin) {
  const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization'
  };
  if (ALLOWED_ORIGINS.includes('*')) headers['Access-Control-Allow-Origin'] = '*';
  else if (ALLOWED_ORIGINS.includes(origin)) headers['Access-Control-Allow-Origin'] = origin;
  return headers;
}
Deno.serve(async (req)=>{
  try {
    const url = new URL(req.url);
    const origin = req.headers.get('origin') || '';
    if (req.method === 'OPTIONS') {
      return new Response(null, {
        status: 204,
        headers: corsHeaders(origin)
      });
    }
    if (req.method === 'POST' && url.pathname.endsWith('/stripe-connect-payout')) {
      if (!STRIPE_SECRET) return new Response(JSON.stringify({
        error: 'Stripe secret not configured'
      }), {
        status: 500,
        headers: corsHeaders(origin)
      });
      const body = await req.json().catch(()=>({}));
      const account = body.account;
      const refresh_url = body.refresh_url;
      const return_url = body.return_url;
      if (!account || !refresh_url || !return_url) {
        return new Response(JSON.stringify({
          error: 'Missing required fields: account, refresh_url, return_url'
        }), {
          status: 400,
          headers: corsHeaders(origin)
        });
      }
      const params = new URLSearchParams();
      params.append('account', account);
      params.append('type', 'account_onboarding');
      params.append('refresh_url', refresh_url);
      params.append('return_url', return_url);
      const result = await stripeRequest('/v1/account_links', 'POST', params.toString());
      const headers = corsHeaders(origin);
      if (result.status >= 400) return new Response(JSON.stringify({
        error: 'Stripe API error',
        details: result.data
      }), {
        status: 502,
        headers
      });
      return new Response(JSON.stringify(result.data), {
        headers
      });
    }
    return new Response(JSON.stringify({
      message: 'Not found'
    }), {
      status: 404,
      headers: corsHeaders(origin)
    });
  } catch (err) {
    console.error(err);
    const origin = req.headers.get('origin') || '';
    return new Response(JSON.stringify({
      error: err.message
    }), {
      status: 500,
      headers: corsHeaders(origin)
    });
  }
});
