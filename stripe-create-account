// stripe-create-account (Edge Function - Deno / Supabase)
// Strict proxy to Stripe POST /v1/accounts
const CORS_HEADERS = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization'
};
console.info('stripe-create-account booting (strict proxy)');
Deno.serve(async (req)=>{
  try {
    // CORS preflight
    if (req.method === 'OPTIONS') return new Response(null, {
      status: 204,
      headers: CORS_HEADERS
    });
    if (req.method !== 'POST') return jsonError('Method not allowed', 405);
    const contentType = req.headers.get('content-type') || '';
    // Accept JSON or form-urlencoded from client, but will send form-urlencoded to Stripe
    if (!(contentType.includes('application/json') || contentType.includes('application/x-www-form-urlencoded'))) return jsonError('Unsupported Content-Type. Use application/json or application/x-www-form-urlencoded', 400);
    // Ensure STRIPE_SECRET is set as a secret in Supabase
    const STRIPE_SECRET = Deno.env.get('STRIPE_TEST_SECRET') || '';
    if (!STRIPE_SECRET) return jsonError('Server misconfiguration (missing Stripe secret)', 500);
    // Parse incoming body
    let bodyObj = {};
    if (contentType.includes('application/json')) {
      try {
        bodyObj = await req.json();
      } catch (err) {
        return jsonError('Invalid JSON body', 400);
      }
    } else {
      // parse x-www-form-urlencoded
      const text = await req.text();
      bodyObj = Object.fromEntries(new URLSearchParams(text));
    }
    // Allow only these fields per Stripe Connect Accounts API
    const allowed = [
      'business_type',
      'type',
      'country',
      'email'
    ];
    const payload = new URLSearchParams();
    for (const key of allowed){
      const v = bodyObj[key];
      if (v !== undefined && v !== null && String(v).length > 0) payload.append(key, String(v));
    }
    // Optional: require at least 'type' and 'email' per common usage (Stripe allows varying required fields by country/type)
    // We'll not enforce server-side beyond letting Stripe validate, but ensure we send something
    if ([
      ...payload.keys()
    ].length === 0) return jsonError('No valid fields provided. Provide at least one of business_type, type, country, email', 400);
    // Call Stripe
    const stripeResp = await fetch('https://api.stripe.com/v1/accounts', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${STRIPE_SECRET}`,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: payload.toString()
    });
    const text = await stripeResp.text();
    let json;
    try {
      json = JSON.parse(text);
    } catch  {
      json = {
        raw: text
      };
    }
    const status = stripeResp.ok ? 200 : 502;
    return new Response(JSON.stringify(json), {
      status,
      headers: {
        ...CORS_HEADERS,
        'Content-Type': 'application/json'
      }
    });
  } catch (err) {
    console.error('Unhandled error', err);
    return jsonError('Internal server error', 500);
  }
});
function jsonError(message, status = 400) {
  return new Response(JSON.stringify({
    error: message
  }), {
    status,
    headers: {
      ...CORS_HEADERS,
      'Content-Type': 'application/json'
    }
  });
}
